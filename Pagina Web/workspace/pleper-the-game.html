<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PLEPER the Game</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
    }
    .pantalla-inicio, .pantalla-juego {
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
    }
    .pantalla-inicio.active, .pantalla-juego.active {
      display: flex;
    }




    h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
        animation: brillarVerde 4s infinite alternate;
}

@keyframes brillarVerde {
  0% {
    color: #ffffff; /* Verde inicial */
    text-shadow: 0 0 5px green;
  }
  50% {
    color: limegreen; /* Verde m√°s brillante */
    text-shadow: 0 0 10px green, 0 0 20px limegreen;
  }
  100% {
    color: white; /* Vuelve al verde inicial */
    text-shadow: 0 0 5px green;
  }
}




    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 1em;
      cursor: pointer;
    }
    .tablero {
      display: grid;
      gap: 5px;
    }
    .celda {
      width: 60px;
      height: 60px;
      background-color: #222;
      border: 1px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
    }
    .iluminada {
      background-color: limegreen !important;
    }
    .falsa {
      background-color: crimson;
    }




    .powerup {
      animation: pulsoPowerUp 1.2s ease-in-out infinite;
  }

  @keyframes pulsoPowerUp {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
  }




    .menu-ajustes {
      background-color: #111;
      border: 2px solid white;
      padding: 20px;
      margin-top: 20px;
    }
    .menu-ajustes label {
      display: block;
      margin-top: 10px;
    }
    #timer {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 1.2em;
    }


    #faseActual {
      position: absolute;
      top: 45px; /* un poco m√°s abajo del cron√≥metro */
      right: 20px;
      font-size: 18px;
      color: white;
      font-family: sans-serif;
    }



    .mensaje-flotante {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background-color: #111;
  border: 2px solid lime;
  color: white;
  padding: 30px;
  font-size: 1.5em;
  z-index: 999;
  text-align: center;
  border-radius: 20px;
  box-shadow: 0 0 20px lime;
  animation: aparecer 0.5s ease-out forwards;
}

#mensajeDerrota {
  border-color: crimson;
  box-shadow: 0 0 20px crimson;
}

.mensaje-flotante button {
  margin-top: 20px;
  padding: 10px 20px;
  font-size: 1em;
  background-color: white;
  color: black;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

@keyframes aparecer {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.6); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}





#fondoConstelaciones {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 0;
  width: 100%;
  height: 100%;
  background: transparent; /* o transparente si ya ten√©s otro fondo */
  z-index: -1; /* Asegura que el canvas est√© detr√°s del contenido */
}

#pantallaInicio {
  position: relative;
  z-index: 1; /* Asegura que el contenido est√© encima del canvas */
}








#overlayConfirmacion {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  opacity: 0;
  pointer-events: none;
  z-index: 998;
  transition: opacity 0.3s ease;
}

#overlayConfirmacion.activo {
  opacity: 1;
  pointer-events: all;
}






#mensajeDesbloqueoFantasma {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #222;
  color: lime;
  padding: 12px 24px;
  font-size: 1.1em;
  border: 2px solid lime;
  border-radius: 12px;
  z-index: 1001;
  animation: aparecerDesaparecer 6s ease forwards;
  pointer-events: none;
}








/* üîî Mensaje de inicio en modo fantasma */
#mensajeInicioFantasma {
  position: absolute;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 12px 20px;
  border: 2px solid crimson;
  border-radius: 12px;
  font-size: 1em;
  z-index: 1000;
  animation: aparecerDesaparecer 3s ease forwards;
  pointer-events: none;
  display: none; /* Se activa por JS */
}

/* ‚ú® Animaci√≥n de entrada y salida */
@keyframes aparecerDesaparecer {
  0% {
    opacity: 0;
    transform: translateX(-50%) translateY(10px);
  }
  10% {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  90% {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateX(-50%) translateY(10px);
  }
}






#mensajePowerUp {

  position: absolute;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 12px 20px;
  border: 2px solid blue;
  border-radius: 12px;
  font-size: 1em;
  z-index: 1000;
  animation: aparecerDesaparecer 3s ease forwards;
  pointer-events: none;
  display: none; /* Se activa por JS */
}

/* ‚ú® Animaci√≥n de entrada y salida */
@keyframes aparecerDesaparecer {
  0% {
    opacity: 0;
    transform: translateX(-50%) translateY(10px);
  }
  10% {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  90% {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateX(-50%) translateY(10px);
  }


}









#menuBoton {
  position: absolute;
  top: 10px;
  left: 10px;
  font-size: 26px;
  cursor: pointer;
  background-color: rgba(255, 255, 255, 0.2);
  padding: 6px 12px;
  border-radius: 8px;
  z-index: 1000;
  color: white;
}

#menuOpciones {
  position: absolute;
  top: 60px;
  left: 10px;
  background-color: rgba(0, 0, 0, 0.95);
  border: 2px solid limegreen;
  padding: 20px 24px;
  border-radius: 14px;
  display: none;
  z-index: 1000;
  width: 260px; /* M√°s ancho */
  height: 260px; /* M√°s alto */
  box-shadow: 0 0 12px limegreen;
  font-size: 18px;
  animation: desplegarMenu 0.3s ease;
}

#menuOpciones button {
  display: block;
  background: rgba(0, 0, 0, 0.542);
  color: white;
  border: 2px solid green;
  margin: 5px 0;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  width: 220px;
  height: 110px; /* M√°s alto */
  text-align: left;
  transition: all 0.4s ease;
}

#menuOpciones button:hover {
  background: black;
  color: white;
  box-shadow: 0 0 3px rgb(25, 166, 23), 0 0 10px rgb(25, 166, 23), 0 0 20px rgb(25, 166, 23), 0 0 25px rgb(25, 166, 23);

  -webkit-box-reflect: below 1px linear-gradient(transparent, #00000005);
}




@keyframes desplegarMenu {
  0% {
    opacity: 0;
    transform: translateY(-10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}




@keyframes replegarMenu {
  0% {
    opacity: 1;
    transform: translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateY(-10px);
  }
}







#menuOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4); /* Sombra negra sutil */
  z-index: 900;
  display: none;
}





/* Bot√≥n "Personajes" */
#btnPersonajes {
  background-color: rgba(0, 0, 0, 0.575);
  color: white;
  border: 2px solid green;
  padding: 10px 20px;
  font-size: 1.2rem;
  border-radius: 5px;
  cursor: pointer;
  position: absolute;
  top: 10px;
  right: 10px;
  transition: background-color 0.3s ease;
  transition: all 0.4s ease;
}

#btnPersonajes:hover {
  background: black;
  color: white;
  box-shadow: 0 0 3px rgb(25, 166, 23), 0 0 10px rgb(25, 166, 23), 0 0 20px rgb(25, 166, 23), 0 0 25px rgb(25, 166, 23);

  -webkit-box-reflect: below 1px linear-gradient(transparent, #00000005);
}




/* Popup selector de personajes */
.popup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  border: 2px solid lime;
  border-radius: 10px;
  padding: 20px;
  z-index: 1000;
  box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
  width: 600px;
  text-align: center;
  max-width: 100%;
  max-height: 100%;
}

/* Grid de emojis */
.emoji-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.emoji-grid span {
  font-size: 2.5rem;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.emoji-grid span:hover {
  transform: scale(1.2);
}

/* Bot√≥n "Cerrar" */
.popup button {
  background-color: #ff4c4c;
  color: white;
  padding: 10px 20px;
  font-size: 1.2rem;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 15px;
}

.popup button:hover {
  background-color: #ff0000;
}



.emoji-grid span.seleccionado {
  outline: 3px solid lime;
  border-radius: 8px;
  background-color: rgba(0, 255, 0, 0.2);
}





.menu-btn {
  background-color: black;
  color: white;
  border: 2px solid green;     /* borde verde */
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 6px;
  margin: 10px 0;
  cursor: pointer;
  transition: all 0.4s ease;  /* fade-in suave */
}

.menu-btn:hover {
  background: black;
  color: white;
  box-shadow: 0 0 3px rgb(25, 166, 23), 0 0 10px rgb(25, 166, 23), 0 0 20px rgb(25, 166, 23), 0 0 25px rgb(25, 166, 23);

  -webkit-box-reflect: below 1px linear-gradient(transparent, #00000005);
}




























  </style>
</head>
<body>
  <div class="pantalla-inicio active" id="pantallaInicio">
    <canvas id="fondoConstelaciones"></canvas>
    <h1>PLEPER the Game</h1>
    <button onclick="iniciarJuego()" class="menu-btn">Jugar</button>
    <button onclick="mostrarAjustes()" class="menu-btn">Ajustes</button>
    <button onclick="alternarSonido()" class="menu-btn">Sonido: <span id="estadoSonido">üîä</span></button>
    <div class="menu-ajustes" id="menuAjustes" style="display:none;">
      <label>Dificultad:
        <select id="dificultad">
          <option value="facil">F√°cil</option>
          <option value="normal" selected>Normal</option>
          <option value="dificil">Dif√≠cil</option>
          <option value="imposible">Imposible</option>
          <option value="fantasma" id="opcionFantasma">Fantasma</option>
        </select>
      </label>
    </div>
    <div style="margin-top: 20px;">
      <h3>R√©cords:</h3>
      <p>F√°cil: <span id="record-facil">-</span> seg</p>
      <p>Normal: <span id="record-normal">-</span> seg</p>
      <p>Dif√≠cil: <span id="record-dificil">-</span> seg</p>
      <p>Imposible: <span id="record-imposible">-</span> seg</p>
      <p>Fantasma: <span id="record-fantasma">-</span> seg</p>
      <button onclick="reiniciarRecords()" class="menu-btn"> Reiniciar R√©cords</button>
    </div>



    <button id="btnPersonajes" onclick="abrirSelectorEmoji()" style="position:absolute; top: 10px; right: 10px;">
      üé≠ Personajes
    </button>



  </div>

  <div class="pantalla-juego" id="pantallaJuego">
    

    <div id="menuBoton">‚ò∞</div>

    <div id="menuOpciones" class="oculto">
      <button onclick="reiniciarPartida()">Reiniciar Partida</button>
      <button onclick="volverAlMenu()">Volver al men√∫</button>
    </div>

    <div id="menuOverlay"></div>

    <div id="timer">Tiempo: <span id="tiempoRestante">01:00</span></div>
    <div id="faseActual">Fase: 1</div>
    <div class="tablero" id="tablero"></div>
  </div>

  <audio id="sonidoOK" src="https://cdn.pixabay.com/audio/2022/03/15/audio_8be0a46b2b.mp3"></audio> 
  <audio id="sonidoError" src="https://cdn.pixabay.com/audio/2022/03/15/audio_e35b9a7b7a.mp3"></audio> 
  <audio id="sonidoVictoria" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c1d6c6ebd6.mp3"></audio>
  <audio id="sonidoDesbloqueo" src="https://cdn.pixabay.com/audio/2022/03/01/audio_8e1f0c06e4.mp3"></audio>



  <!-- Mensaje de Victoria -->
<div id="mensajeVictoria" class="mensaje-flotante" style="display:none;">
  üéâ ¬°Felicidades, completaste la fase! üéâ<br>
  <button onclick="continuarFase()">üëâ Continuar</button>
  <button onclick="volverAlMenu()">üè† Volver al Men√∫</button>
</div>

<!-- Mensaje de Derrota -->
<div id="mensajeDerrota" class="mensaje-flotante" style="display:none;">
  ‚ùå ¬°Pisaste una baldosa falsa o se acab√≥ el tiempo! ‚ùå<br>
  <button onclick="reintentarFase()">üîÅ Reintentar</button>
  <button onclick="volverAlMenu()">üè† Volver al Men√∫</button>
</div>

<style>
  .mensaje-flotante {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #111;
    border: 2px solid limegreen;
    padding: 30px;
    font-size: 1.3em;
    text-align: center;
    z-index: 999;
    box-shadow: 0 0 15px limegreen;
    border-radius: 12px;
  }

  .mensaje-flotante button {
    margin-top: 15px;
    margin-inline: 10px;
    padding: 10px 20px;
    font-size: 1em;
    cursor: pointer;
  }
</style>




  <script>




    let emojiJugador = localStorage.getItem("emojiJugador") || "üï¥Ô∏è";

    let tiempoRestante = 0;
    let tiempoMaximo = 0; // Tiempo m√°ximo para la fase actual
    let ultimoTiempo = 0;

    let juegoPausado = false;


    let juegoActivo = true;

    let pausaDesde = 0;



    let pausaTiempo = 0; // Cu√°nto dur√≥ la pausa
    let tiempoCuandoSePauso = 0;
    let tiempoRestanteCongelado = 0;


    let modoFantasma = false;
    let powerUpX = null, powerUpY = null;





    let ancho, alto, dificultad, fase = 1;
    function obtenerTiempoMaximo() {
    switch (dificultad) {
    case "facil":
    case "normal":
    case "dificil":
      return 30 * 1000; // 30 segundos
    case "imposible":
    default:
      return 60 * 1000; // 1 minuto
  }
}
    let posX = 0, posY = 0;
    let baldosas = [];
    let inicioTiempo, intervaloTiempo, intervaloCambios, intervaloActualizacion;
    let sonidoActivado = true;

    const pantallaInicio = document.getElementById("pantallaInicio");
    const pantallaJuego = document.getElementById("pantallaJuego");
    const tablero = document.getElementById("tablero");
    const estadoSonido = document.getElementById("estadoSonido");
    const tiempoRestanteElemento = document.getElementById("tiempoRestante");

    const sonidoOK = document.getElementById("sonidoOK");
    const sonidoError = document.getElementById("sonidoError");
    const sonidoVictoria = document.getElementById("sonidoVictoria");

    const records = {
      facil: document.getElementById("record-facil"),
      normal: document.getElementById("record-normal"),
      dificil: document.getElementById("record-dificil"),
      imposible: document.getElementById("record-imposible"),
      fantasma: document.getElementById("record-fantasma")
    };

    function configurarDificultad(nombre) {
      dificultad = nombre;
      switch(nombre) {
        case "facil": ancho = alto = 5; break;
        case "normal": ancho = alto = 7; break;
        case "dificil": ancho = alto = 10; break;
        case "imposible": ancho = alto = 10; break;
        case "fantasma": ancho = alto = 10; break;
      }
    }

    function crearTablero() {
      baldosas = [];
      tablero.innerHTML = "";
      tablero.style.gridTemplateColumns = `repeat(${ancho}, 60px)`;
      for (let y = 0; y < alto; y++) {
        let fila = [];
        for (let x = 0; x < ancho; x++) {
          const div = document.createElement("div");
          div.className = "celda";
          tablero.appendChild(div);
          fila.push({ div, iluminada: false, falsa: false, esPowerUp: false });
        }
        baldosas.push(fila);
      }
    }

function colocarFalsas() {
  baldosas.flat().forEach(c => {
    c.div.classList.remove("falsa");
    c.falsa = false;
  });

  // Aumentar la cantidad de falsas seg√∫n la fase (m√°ximo 35%)
  let porcentaje = Math.min(0.10 + fase * 0.02, 0.35);
  let cantidad = Math.floor(ancho * alto * porcentaje);

  let intentos = 0;
  do {
    intentos++;
    baldosas.flat().forEach(c => {
      c.div.classList.remove("falsa");
      c.falsa = false;
    });

    let colocadas = 0;
    while (colocadas < cantidad) {
      let x = Math.floor(Math.random() * ancho);
      let y = Math.floor(Math.random() * alto);
      if ((x === 0 && y === 0) || baldosas[y][x].falsa) continue;

      const celda = baldosas[y][x];
      celda.falsa = true;

      if (celda.iluminada) {
        celda.div.classList.add("falsa");
        // Mostrar roja por 5 segundos si ya estaba iluminada
        setTimeout(() => {
          if (celda.iluminada) celda.div.classList.remove("falsa");
        }, 5000);
      } else {
        celda.div.classList.add("falsa");
      }

      colocadas++;
    }
  } while (!verificarAccesibilidad() && intentos < 10);

  function verificarAccesibilidad() {
    const visitado = Array.from({ length: alto }, () => Array(ancho).fill(false));

    function dfs(x, y) {
      if (x < 0 || y < 0 || x >= ancho || y >= alto) return;
      if (visitado[y][x] || baldosas[y][x].falsa) return;
      visitado[y][x] = true;
      dfs(x + 1, y);
      dfs(x - 1, y);
      dfs(x, y + 1);
      dfs(x, y - 1);
    }

    dfs(0, 0); // Empezar desde la esquina

    // Todas las celdas no falsas deben ser accesibles
    return baldosas.flat().every((c, i) => {
      const x = i % ancho;
      const y = Math.floor(i / ancho);
      return c.falsa || visitado[y][x];
    });
  }



  if (modoFantasma) {
  baldosas.flat().forEach(c => {
    if (c.falsa) c.div.classList.remove("falsa"); // Oculta falsedad visual
  });
}



}
 

    function mover(dx, dy) {
      if (!juegoActivo) return; // Evita mover si el juego termin√≥
      const nuevoX = posX + dx;
      const nuevoY = posY + dy;
      if (nuevoX < 0 || nuevoY < 0 || nuevoX >= ancho || nuevoY >= alto) return;
      posX = nuevoX;
      posY = nuevoY;
      dibujar();
      verificarVictoria();
    }

    function iluminar(x, y) {
      const celda = baldosas[y][x];
      if (!celda.iluminada) {
        celda.div.classList.add("iluminada");
        celda.iluminada = true;
      }
    }

    function dibujar() {


      baldosas.flat().forEach(c => c.div.classList.remove("powerup"));

        // Limpia todas las celdas
    baldosas.flat().forEach(c => {
    c.div.innerHTML = "";

    // Si hay power-up en esa celda y NO es la actual del jugador
    if (modoFantasma && c.esPowerUp) {
      const esCeldaJugador = (baldosas[posY][posX] === c);
      if (!esCeldaJugador) {
        c.div.innerHTML = "üëÅÔ∏è";
        c.div.classList.add("powerup");
      }
    }
  });

  const celda = baldosas[posY][posX];

  // Si el jugador pisa el power-up
  if (modoFantasma && celda.esPowerUp) {
    revelarFalsasTemporalmente();
    celda.esPowerUp = false;
    powerUpX = powerUpY = null;
  }

  // Mostrar al jugador
  celda.div.innerHTML = emojiJugador;




      if (celda.falsa && !celda.iluminada) {
      juegoActivo = false; // Evita mover si el juego termin√≥
      reproducir(sonidoError);
      clearInterval(intervaloTiempo);
      clearInterval(intervaloCambios);
      clearInterval(intervaloActualizacion);
      document.getElementById("mensajeDerrota").style.display = "block";
      return;
      }
      reproducir(sonidoOK);
      iluminar(posX, posY);
    }

    function verificarVictoria() {
  const todasIluminadas = baldosas.flat().every(c => c.iluminada || c.falsa);
  if (todasIluminadas) {
    juegoActivo = false; // Evita mover si el juego termin√≥
    clearInterval(intervaloTiempo);
    clearInterval(intervaloCambios);
    clearInterval(intervaloActualizacion);

    const tiempoFinal = ((Date.now() - inicioTiempo) / 1000).toFixed(2);
    reproducir(sonidoVictoria);
    actualizarRecord(dificultad, tiempoFinal);


    // Desbloquear Modo Fantasma si super√≥ al menos una fase de "Imposible"
    if (dificultad === "imposible") {
    localStorage.setItem("modoFantasmaDesbloqueado", "true");


    // Si la opci√≥n a√∫n no existe (por ejemplo, fue ocultada), volver a mostrarla
    const opcionFantasma = document.getElementById("opcionFantasma");
    if (opcionFantasma && opcionFantasma.style.display === "none") {
      opcionFantasma.style.display = "block";
    }


    // Mostrar mensaje de desbloqueo SOLO si nunca fue mostrado
if (dificultad === "imposible") {
  localStorage.setItem("modoFantasmaDesbloqueado", "true");

  if (!localStorage.getItem("mensajeFantasmaMostrado")) {
    localStorage.setItem("mensajeFantasmaMostrado", "true");

    const msj = document.getElementById("mensajeDesbloqueoFantasma");
    msj.style.display = "block";

    if (sonidoActivado) {
      const audio = document.getElementById("sonidoDesbloqueo");
      audio.currentTime = 0;
      audio.play();
    }

    // Ocultarlo despu√©s de 3 segundos
    setTimeout(() => {
      msj.style.display = "none";
    }, 3000);
  }
}

}


    document.getElementById("mensajeVictoria").style.display = "block";
    fase++;
  }
}

    // let fase = 1; // Eliminado para evitar redeclaraci√≥n

function iniciarJuego() {


  modoFantasma = document.getElementById("dificultad").value === "fantasma";



  configurarDificultad(document.getElementById("dificultad").value);
  // fase = 1; <-- sacalo de ac√°
  pantallaInicio.classList.remove("active");
  pantallaJuego.classList.add("active");
  iniciarFase();


}

    function iniciarFase() {
      juegoActivo = true; //  Vuelve a estar activo para la pr√≥xima partida
      document.getElementById("faseActual").textContent = "Fase: " + fase;
      crearTablero();
      colocarFalsas();




       if (modoFantasma) {
    // Mostrar las falsas por 3 segundos al inicio
    baldosas.flat().forEach(c => {
      if (c.falsa) c.div.classList.add("falsa");
    });


    // Mostrar mensaje "Observ√° las falsas"
    const msj = 
  document.getElementById("mensajeInicioFantasma");
    msj.style.display = "block";

    setTimeout(() => {
      baldosas.flat().forEach(c => {
        if (c.falsa) c.div.classList.remove("falsa");
      });
      msj.style.display = "none";
    }, 3000);


      // Coloca el power-up en una baldosa v√°lida
        let colocado = false;
        while (!colocado) {
          let x = Math.floor(Math.random() * ancho);
          let y = Math.floor(Math.random() * alto);
          if (!baldosas[y][x].falsa && !(x === 0 && y === 0)) {
            baldosas[y][x].esPowerUp = true;
            powerUpX = x;
            powerUpY = y;
            colocado = true;
          }
        }
     }




      posX = 0; posY = 0;
      baldosas.flat().forEach(c => {
        c.iluminada = false;
        c.div.classList.remove("iluminada");
      });
      dibujar();
      

    tiempoMaximo = obtenerTiempoMaximo();
    tiempoRestante = tiempoMaximo;
    inicioTiempo = Date.now();

      clearInterval(intervaloActualizacion);
      intervaloActualizacion = setInterval(actualizarTiempoRestante, 250);

      clearInterval(intervaloCambios);
      if (dificultad === "imposible") {
        intervaloCambios = setInterval(colocarFalsas, 5000);
      }
    }

function actualizarTiempoRestante() {
  if (juegoPausado) {
    // Mostrar el tiempo congelado sin modificar nada
    tiempoRestanteElemento.textContent = formatearTiempo(tiempoRestante);
    return;
  }

  // Calcular tiempo restante real
  const tiempoMs = Math.max(0, tiempoMaximo - (Date.now() - inicioTiempo));
  tiempoRestante = tiempoMs; // <-- actualiza la variable global real

  // Mostrar en pantalla
  tiempoRestanteElemento.textContent = formatearTiempo(tiempoRestante);

  // Cambiar color si queda poco
  const segundos = Math.floor(tiempoMs / 1000);
  tiempoRestanteElemento.style.color = (segundos <= 10) ? "red" : "white";

  // Verificar derrota
  if (tiempoRestante <= 0) {
    clearInterval(intervaloActualizacion);
    document.getElementById("mensajeDerrota").style.display = "block";
    juegoActivo = false;
  }
}

    function actualizarRecord(dif, tiempo) {
      const clave = `record-${dif}`;
      const recordGuardado = localStorage.getItem(clave);
      if (!recordGuardado || parseFloat(tiempo) < parseFloat(recordGuardado)) {
        localStorage.setItem(clave, tiempo);
      }
    }

    function cargarRecords() {
      ["facil", "normal", "dificil", "imposible", "fantasma"].forEach(d => {
        const t = localStorage.getItem(`record-${d}`);
        records[d].textContent = t ? t : "-";
      });


      // Controla si el modo fantasma est√° desbloqueado
      const fantasmaDesbloqueado = localStorage.getItem("modoFantasmaDesbloqueado") === "true";
      const opcionFantasma = document.getElementById("opcionFantasma");
      if (!fantasmaDesbloqueado && opcionFantasma) {
      opcionFantasma.style.display = "none";
    }
    else if (fantasmaDesbloqueado && opcionFantasma) {
    opcionFantasma.style.display = "block";
  }

}



function volverAlMenu() {
  pantallaJuego.classList.remove("active");
  pantallaInicio.classList.add("active");

  document.getElementById("mensajeVictoria").style.display = "none";
  document.getElementById("mensajeDerrota").style.display = "none";

  clearInterval(intervaloTiempo);
  clearInterval(intervaloCambios);
  clearInterval(intervaloActualizacion);

  juegoActivo = false;  //  Detiene el juego
  fase = 1;              //  Reinicia la fase a 1


  juegoPausado = false;
  pausaDesde = 0;
  inicioTiempo = 0;


}
    

    function mostrarAjustes() {
      const ajustes = document.getElementById("menuAjustes");
      ajustes.style.display = ajustes.style.display === "none" ? "block" : "none";
    }

    function alternarSonido() {
      sonidoActivado = !sonidoActivado;
      estadoSonido.textContent = sonidoActivado ? "üîä" : "üîá";
    }

    function reproducir(audio) {
      if (sonidoActivado) {
        audio.currentTime = 0;
        audio.play();
      }
    }

document.addEventListener("keydown", (e) => {
  if (juegoPausado || !juegoActivo) return;

  switch (e.key) {
    case "ArrowUp": mover(0, -1); break;
    case "ArrowDown": mover(0, 1); break;
    case "ArrowLeft": mover(-1, 0); break;
    case "ArrowRight": mover(1, 0); break;
  }
});

    document.addEventListener("touchstart", (e) => {
      if (!juegoActivo) return; // Evita mover si el juego termin√≥
      const touchX = e.touches[0].clientX;
      const touchY = e.touches[0].clientY;
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      const dx = touchX - centerX;
      const dy = touchY - centerY;
      if (Math.abs(dx) > Math.abs(dy)) {
        mover(dx > 0 ? 1 : -1, 0);
      } else {
        mover(0, dy > 0 ? 1 : -1);
      }
    });








    function mostrarMensajeVictoria() {
      juegoActivo = false;
  document.getElementById("mensajeVictoria").style.display = "block";
}

function cerrarMensajeVictoria() {
  document.getElementById("mensajeVictoria").style.display = "none";
  fase++;
  iniciarFase();
}

function mostrarMensajeDerrota() {
  juegoActivo = false;
  document.getElementById("mensajeDerrota").style.display = "block";
}

    cargarRecords();








    function reintentarFase() {
      fase = 1; // Reinicia la fase a 1
  // Oculta mensaje de derrota
  document.getElementById("mensajeDerrota").style.display = "none";

  // Limpia todo como si empezara la fase desde cero
  clearInterval(intervaloTiempo);
  clearInterval(intervaloCambios);
  clearInterval(intervaloActualizacion);

  juegoActivo = true; // üü¢ Vuelve a estar activo para la pr√≥xima partida

  // Vuelve a reproducir el sonido inicial si est√° activado
  if (sonidoActivado) {
    sonidoOK.currentTime = 0;
    sonidoOK.play();
  }

  // Reinicia la fase con todo: tablero nuevo, falsas nuevas, cron√≥metro reiniciado
  iniciarFase();
}







function continuarFase() {
  document.getElementById("mensajeVictoria").style.display = "none";
  setTimeout(() => {
    iniciarFase();
  }, 1000); // Espera 3 segundos antes de cargar la siguiente ronda
}

function reintentarFase() {
  fase = 1; // Reinicia la fase a 1
  document.getElementById("mensajeDerrota").style.display = "none";

  clearInterval(intervaloTiempo);
  clearInterval(intervaloCambios);
  clearInterval(intervaloActualizacion);

  if (sonidoActivado) {
    sonidoOK.currentTime = 0;
    sonidoOK.play();
  }

  iniciarFase();
}














const canvas = document.getElementById("fondoConstelaciones");
const ctx = canvas.getContext("2d");
let puntos = [];
let mouse = { x: null, y: null };

function ajustarCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

window.addEventListener("resize", ajustarCanvas);
ajustarCanvas();

for (let i = 0; i < 100; i++) {
  puntos.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    vx: (Math.random() - 0.5) * 0.5,
    vy: (Math.random() - 0.5) * 0.5
  });
}

canvas.addEventListener("mousemove", (e) => {
  mouse.x = e.clientX;
  mouse.y = e.clientY;
});

function animarFondo() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let p of puntos) {
    p.x += p.vx;
    p.y += p.vy;

    if (p.x <= 0 || p.x >= canvas.width) p.vx *= -1;
    if (p.y <= 0 || p.y >= canvas.height) p.vy *= -1;

    ctx.beginPath();
    ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
    ctx.fillStyle = "rgb(25, 166, 23)";
    ctx.fill();
  }

  for (let i = 0; i < puntos.length; i++) {
    for (let j = i + 1; j < puntos.length; j++) {
      const a = puntos[i];
      const b = puntos[j];
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < 100) {
        ctx.beginPath();
        ctx.strokeStyle = "rgb(25, 166, 23)"
        ctx.lineWidth = 0.5;
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
      }
    }

    // Conexiones con el mouse
    if (mouse.x !== null) {
      const dx = puntos[i].x - mouse.x;
      const dy = puntos[i].y - mouse.y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < 120) {
        ctx.beginPath();
        ctx.strokeStyle = "rgb(25, 166, 23)"
        ctx.lineWidth = 0.7;
        ctx.moveTo(puntos[i].x, puntos[i].y);
        ctx.lineTo(mouse.x, mouse.y);
        ctx.stroke();
      }
    }
  }

  requestAnimationFrame(animarFondo);
}

animarFondo();






function reiniciarRecords() {
  document.getElementById("overlayConfirmacion").classList.add("activo");
  document.getElementById("overlayConfirmacion").style.display = "block";
  document.getElementById("ventanaConfirmacion").style.display = "block";
}

function confirmarReinicio() {
  ["facil", "normal", "dificil", "imposible", "fantasma"].forEach(d => {
    localStorage.removeItem(`record-${d}`);
  });


   // Bloquear nuevamente el modo fantasma
  localStorage.removeItem("modoFantasmaDesbloqueado");
  localStorage.removeItem("mensajeFantasmaMostrado");

  cargarRecords();
  cerrarVentanaConfirmacion();
}

function cancelarReinicio() {
  cerrarVentanaConfirmacion();
}

function cerrarVentanaConfirmacion() {
  const overlay = document.getElementById("overlayConfirmacion");
  const ventana = document.getElementById("ventanaConfirmacion");
  
  overlay.classList.remove("activo");
  ventana.style.display = "none";

  // Espera que termine la animaci√≥n antes de ocultar el overlay
  setTimeout(() => {
    overlay.style.display = "none";
  }, 300); // coincide con el tiempo del transition
}







  function revelarFalsasTemporalmente() {
  baldosas.flat().forEach(c => {
    if (c.falsa) c.div.classList.add("falsa");
  });

  mostrarMensajePowerUp();

  setTimeout(() => {
    baldosas.flat().forEach(c => {
      if (c.falsa) c.div.classList.remove("falsa");
    });
  }, 5000);
}




function mostrarMensajePowerUp() {
  const mensaje = document.getElementById("mensajePowerUp");
  mensaje.style.display = "block";

  setTimeout(() => {
    mensaje.style.display = "none";
  }, 5000);
}





function reiniciarPartida() {
  fase = 1;
  juegoPausado = false; // üîì Despausar
  pausaDesde = 0;
  tiempoRestanteCongelado = 0;

  document.getElementById("menuOpciones").style.display = "none"; // Cierra el men√∫

  document.getElementById("menuOverlay").style.display = "none"; // Cierra el overlay

  // Si ten√©s alg√∫n mensaje de derrota/victoria, asegurate de ocultarlo tambi√©n:
  document.getElementById("mensajeVictoria").style.display = "none";
  document.getElementById("mensajeDerrota").style.display = "none";

  iniciarFase(); // Comienza desde cero
}




const menuBoton = document.getElementById("menuBoton");
const menuOpciones = document.getElementById("menuOpciones");
const menuOverlay = document.getElementById("menuOverlay");


// BOT√ìN DE MEN√ö (arriba a la izquierda)
menuBoton.addEventListener("click", (e) => {
  e.stopPropagation();

  const abierto = menuOpciones.style.display === "block";

  if (!abierto) {
    // ABRIR MEN√ö
    menuOpciones.style.display = "block";
    menuOpciones.style.animation = "none";
    menuOpciones.offsetHeight;
    menuOpciones.style.animation = "desplegarMenu 0.3s ease";

    juegoPausado = true;
    pausaDesde = Date.now();

    menuOverlay.style.display = "block";
  } else {
    cerrarMenuPausa(); // reutilizamos funci√≥n
  }
});

// üîÅ CLICK FUERA DEL MEN√ö
document.addEventListener("click", (e) => {
  const esClickDentro = menuOpciones.contains(e.target) || menuBoton.contains(e.target);
  if (!esClickDentro && menuOpciones.style.display === "block") {
    cerrarMenuPausa();
  }
});

// üîÅ CLICK EN OVERLAY
menuOverlay.addEventListener("click", cerrarMenuPausa);

// üîÅ TECLA ESCAPE
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && juegoActivo) {
    const abierto = menuOpciones.style.display === "block";

    if (abierto) {
      // Si ya est√° abierto ‚Üí lo cierra
      cerrarMenuPausa();
    } else {
      // Si est√° cerrado ‚Üí lo abre y pausa el juego
      menuOpciones.style.display = "block";
      menuOpciones.style.animation = "desplegarMenu 0.3s ease";
      menuOverlay.style.display = "block";

      juegoPausado = true;
      pausaDesde = Date.now();
      tiempoRestanteCongelado = tiempoRestante;
    }
  }
});

// ‚úÖ FUNCI√ìN √öNICA PARA CERRAR EL MEN√ö Y REANUDAR BIEN
function cerrarMenuPausa() {
  menuOpciones.style.animation = "replegarMenu 0.3s ease";
  setTimeout(() => {
    menuOpciones.style.display = "none";
  }, 300);

  menuOverlay.style.display = "none";

  juegoPausado = false;

  if (inicioTiempo && pausaDesde) {
  const pausaDuracion = Date.now() - pausaDesde;
  inicioTiempo += pausaDuracion;
  pausaDesde = 0;
}
}





function formatearTiempo(ms) {
  if (isNaN(ms) || ms < 0) ms = 0;
  const segundos = Math.floor(ms / 1000);
  const minutos = Math.floor(segundos / 60);
  const restoSegundos = segundos % 60;
  return `${minutos.toString().padStart(2, "0")}:${restoSegundos.toString().padStart(2, "0")}`;
}






function abrirSelectorEmoji() {
  const selector = document.getElementById("selectorEmoji");
  selector.style.display = "block";
  actualizarResaltadoEmoji();
}







function cerrarSelectorEmoji() {
  document.getElementById("selectorEmoji").style.display = "none";
}

function elegirEmoji(nuevoEmoji) {
  emojiJugador = nuevoEmoji;
  localStorage.setItem("emojiJugador", nuevoEmoji);
  cerrarSelectorEmoji();
  actualizarResaltadoEmoji();
}








function actualizarResaltadoEmoji() {
  const emojis = document.querySelectorAll(".emoji-grid span");
  emojis.forEach(span => {
    if (span.textContent === emojiJugador) {
      span.classList.add("seleccionado");
    } else {
      span.classList.remove("seleccionado");
    }
  });
}


























  </script>



<div id="mensajePowerUp" style="display:none;">üëÅÔ∏è Baldosas falsas reveladas por 5 segundos</div>

<div id="mensajeDesbloqueoFantasma" style="display:none;">
  üëª ¬°Modo Fantasma desbloqueado!
</div>


<div id="mensajeInicioFantasma" style="display:none;">
  üëÄ Observ√° las baldosas falsas (3 segundos)
</div>


<!-- Fondo oscuro detr√°s del mensaje -->
<div id="overlayConfirmacion" style="display:none;"></div>

<!-- Ventana flotante de confirmaci√≥n -->
<div id="ventanaConfirmacion" class="mensaje-flotante" style="display:none;">
  ‚ö†Ô∏è ¬øQuer√©s borrar todos los r√©cords?<br>
  <button onclick="confirmarReinicio()">S√≠</button>
  <button onclick="cancelarReinicio()">No</button>
</div>





<div id="selectorEmoji" class="popup" style="display:none;">
  <p>Eleg√≠ tu personaje:</p>
  <div class="emoji-grid">
    <span onclick="elegirEmoji('üêê')">üêê</span>
    <span onclick="elegirEmoji('üëª')">üëª</span>
    <span onclick="elegirEmoji('üèá')">üèá</span>
    <span onclick="elegirEmoji('üï∫')">üï∫</span>
    <span onclick="elegirEmoji('üöÄ')">üöÄ</span>
    <span onclick="elegirEmoji('üèãÔ∏è')">üèãÔ∏è</span>
    <span onclick="elegirEmoji('üöí')">üöí</span>
    <span onclick="elegirEmoji('üöó')">üöó</span>
    <span onclick="elegirEmoji('ü¶∏')">ü¶∏</span>

    <span onclick="elegirEmoji('üóø')">üóø</span>
    <span onclick="elegirEmoji('üõ•Ô∏è')">üõ•Ô∏è</span>
    <span onclick="elegirEmoji('üöÅ')">üöÅ</span>
    <span onclick="elegirEmoji('‚úàÔ∏è')">‚úàÔ∏è</span>
    <span onclick="elegirEmoji('üöú')">üöú</span>

    <span onclick="elegirEmoji('üèá')">üèá</span>
    <span onclick="elegirEmoji('üíÉ')">üíÉ</span>
    <span onclick="elegirEmoji('üèéÔ∏è')">üèéÔ∏è</span>
    <span onclick="elegirEmoji('üí©')">üí©</span>
    <span onclick="elegirEmoji('üöï')">üöï</span>

    <span onclick="elegirEmoji('üöì')">üöì</span>
    <span onclick="elegirEmoji('üï¥Ô∏è')">üï¥Ô∏è</span>
    <span onclick="elegirEmoji('üßç')">üßç</span>
    <span onclick="elegirEmoji('‚õÑ')">‚õÑ</span>
    <span onclick="elegirEmoji('üéÉ')">üéÉ</span>

    <span onclick="elegirEmoji('üêÅ')">üêÅ</span>
    <span onclick="elegirEmoji('üêñ')">üêñ</span>
    <span onclick="elegirEmoji('üêà')">üêà</span>
    <span onclick="elegirEmoji('üêï')">üêï</span>
    <span onclick="elegirEmoji('üê•')">üê•</span>

    <span onclick="elegirEmoji('üêß')">üêß</span>
    <span onclick="elegirEmoji('ü¶Ü')">ü¶Ü</span>
    <span onclick="elegirEmoji('‚öΩ')">‚öΩ</span>
    <span onclick="elegirEmoji('üèÄ')">üèÄ</span>
    <span onclick="elegirEmoji('üé≤')">üé≤</span>
    <span onclick="elegirEmoji('üèà')">üèà</span> 
    <!-- Agreg√° m√°s emojis despu√©s -->
  </div>
  <button onclick="cerrarSelectorEmoji()">Cerrar</button>
</div>




</body>
</html> 